# 分布式系统

[MIT 6.824: Distributed Systems](https://pdos.csail.mit.edu/6.824/index.html)

## 第1章 分布式系统介绍

### 基本概念

分布式系统（Distributed Systems）：采用计算机集群来解决问题

分布式系统通常比单机解决问题的方式更复杂，采用分布式系统的原因有：

- **并行化**：提高性能
- **容错率**：多个节点，防止其中一个崩溃造成系统性问题
- **物理要求**：如距离较远的服务器之间通信
- **安全性**：孤立多台计算机保证信息安全

然而，**concurrency**、**partial failure**、**performance**也常是分布式系统的应用难点



labs:

1. MapReduce
2. Raft算法
3. 运用Raft算法的KV服务器
4. 分片式KV服务器



分布式基础设施：

- 存储storage
- 计算computation
- 通信communication



**RPC**，remote procedure call，远程过程调用：目的是为了掩盖在不可靠网络上通信的事实



容错性（Fault Tolerance）：

- 可用性（Availability）
- 可恢复性（Recoverability）
- 持久化（NV storage）
- 复制（Replication）



**一致性**（consistency）问题

- 强一致性系统：保证每次请求一定能得到最新的值。通常需要更高的通信成本
- 弱一致性系统：不保证请求能得到最新的值





### MapReduce

论文链接：[MapReduce (2004)](https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf)

MapReduce是一种编程模式，包含Map功能和Reduce功能

外部调用Map(file, value) ---> emit(k, v) ---> Reduce(k, v) ---> emit(len(v))



#### Lab1: MapReduce

[6.824 Lab 1: MapReduce](https://pdos.csail.mit.edu/6.824/labs/lab-mr.html)



设计思路：

- 生产者-消费者模式
- coordinator一次性生产n个map任务，由多个worker通过rpc来取
- n个map任务全部完成后coordinator再一次性生产m个reduce任务
- 设计Task类，包含id、type等属性，用来表示具体的任务
  - 使用缓冲容量为n的channel存放map的task
  - 使用缓冲容量为m的channel存放reduce的task
- 设计TaskMetaInfo类表示任务元信息，用来记录task指针和状态、开始时间，由MetaHolder保存在分别对应map和reduce的两个指针切片中
  - 状态有三种：WAITING、RUNNING、DONE，分别表示未分配、已分配未完成、已完成
  - MetaHolder在每次worker请求task或汇报完成task时，扫描切片并修改状态
  - coordinator初始化后启动一个goroutine用于定时检查任务是否完成，其中需要MetaHolder扫描切片的任务状态
  - coordinator包含一个 `sync.Mutex` 互斥锁，用来保证请求task和扫描元信息切片时的**并发安全**
- 设计一个channel，在定时检查到全部任务结束后用来保证此时前来请求任务的worker能与coordinator基本在**同一时间退出**
- 利用 `ioutil.TempFile()` 实现map和reduce输出文件时，所有临时文件写完后再重命名，若此间进程意外崩溃则写出的文件不可用
- 利用一个goroutine实现定时对所有worker的**任务超时检测**，此时利用到MetaHolder里元信息记录的起始时间和当前时间进行推算，对于超时的task则重新设置状态为WAITING

